<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>中部电信可访问的 DNS 服务器 Benchmark</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
      }
      .container {
        max-width: 97%;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2,
      h3 {
        text-align: center;
        color: #333;
      }
      .chart-container {
        margin-top: 30px;
      }
      .chart-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .chart-row .chart-container {
        width: 49%; /* 确保两个图表能在一行内显示,留有一些间距 */
        margin-bottom: 20px; /* 添加一些底部边距 */
      }
      #toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
      }
      #toast.show {
        visibility: visible;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>中部电信可访问的 DNS 服务器 Benchmark</h1>
      <div id="chartsTop"></div>
      <div id="chartsSorted"></div>
    </div>
    <div id="toast"></div>

    <script>
      const data = { JSON_DATA };
      const servers = Object.keys(data).filter(
        (server) => server.includes("://") && data[server].totalSuccessResponses > 1 && data[server].latencyStats?.meanMs > 1
      );

      const chartConfigs = [
        {
          id: "totalScoreChart",
          label: "总分(越大越好)",
          dataKey: "scores.total_score",
          yAxisLabel: "总分",
          sortOrder: "desc",
        },
        {
          id: "meanLatencyChart",
          label: "平均延迟(越小越好)",
          dataKey: "latencyStats.meanMs",
          yAxisLabel: "延迟 (ms)",
          sortOrder: "asc",
        },
        {
          id: "stdLatencyChart",
          label: "延迟标准差(越小稳定性越好)",
          dataKey: "latencyStats.stdMs",
          yAxisLabel: "标准差 (ms)",
          sortOrder: "asc",
        },
        {
          id: "p90LatencyChart",
          label: "P90延迟(即90%的请求延迟都小于这个值)",
          dataKey: "latencyStats.p90Ms",
          yAxisLabel: "延迟 (ms)",
          sortOrder: "asc",
        },
      ];

      // 创建必要的容器元素
      function createContainers() {
        const chartsTop = document.getElementById('chartsTop');
        const chartsSorted = document.getElementById('chartsSorted');
        
        // 为 Top 图表创建多个新的行
        const numRows = Math.ceil(chartConfigs.length / 2);
        for (let i = 0; i < numRows; i++) {
          const topChartRow = document.createElement('div');
          topChartRow.id = `topChartRow${i + 1}`;
          topChartRow.className = 'chart-row';
          chartsTop.appendChild(topChartRow);
        }
        
        // 确保 chartsSorted 存在
        if (!chartsSorted) {
          const chartsSortedDiv = document.createElement('div');
          chartsSortedDiv.id = 'chartsSorted';
          document.querySelector('.container').appendChild(chartsSortedDiv);
        }
      }

      // 在定义完 chartConfigs 后调用此函数
      createContainers();

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      function createChart(containerId, config, sortedData = null, limit = null, geoFilter = null) {
        const canvas = document.createElement("canvas");
        canvas.id = config.id + (sortedData ? (limit ? "Top" : "Sorted") : "Raw") + (geoFilter ? geoFilter : "Nop");
        const chartContainer = document.createElement("div");
        chartContainer.className = "chart-container";
        chartContainer.appendChild(canvas);
        document.getElementById(containerId).appendChild(chartContainer);

        let serverData;
        if (sortedData) {
          serverData = sortedData.map((item) => ({
            ...item,
            geocode: data[item.server].geocode,
          }));
        } else {
          serverData = servers
            .map((server) => ({
              server,
              value: config.dataKey.split(".").reduce((obj, key) => obj && obj[key], data[server]),
              geocode: data[server].geocode,
            }))
            .filter((item) => item.value !== undefined);
        }

        // 应用地理过滤器
        if (geoFilter) {
          serverData = serverData.filter((item) => {
            const geocode = item.geocode || "";
            switch (geoFilter) {
              case "CN+HK+TW":
                return geocode === "CN" || geocode === "HK" || geocode === "TW";
              case "JP+KR+SG+US":
                return geocode === "JP" || geocode === "KR" || geocode === "SG" || geocode === "US";
              case "其他(包括具有全球 CDN 的服务商)":
                return !["CN", "HK", "TW", "JP", "KR", "SG", "US"].includes(geocode);
              default:
                return true;
            }
          });
        }

        if (limit) {
          serverData = serverData.slice(0, limit);
        }

        const chartData = serverData.map((item) => item.value);
        const chartLabels = serverData.map((item) => `${item.server} (${item.geocode})`);

        // 如果过滤后没有数据，则不创建图表
        if (chartData.length === 0) {
          console.log(`No data available for ${config.label} with filter ${geoFilter}`);
          return;
        }

        new Chart(canvas, {
          type: "bar",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: config.label + (geoFilter ? ` - ${geoFilter}` : "") + (limit ? " - 排行" : " - 原始结果"),
                data: chartData,
                backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: config.yAxisLabel,
                },
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const serverKey = chartLabels[index].split(" ")[0];
                navigator.clipboard.writeText(serverKey).then(() => {
                  showToast(`已复制服务器地址: ${serverKey}`);
                });
              }
            },
          },
        });
      }

      const geoFilters = ["CN+HK+TW", "JP+KR+SG+US", "其他(包括具有全球 CDN 的服务商)"];

      // 创建排序后的图表
      chartConfigs.forEach((config, index) => {
        const sortedData = servers
          .map((server) => {
            const keys = config.dataKey.split(".");
            const value = keys.reduce((obj, key) => obj && obj[key], data[server]);
            return { server, value };
          })
          .filter((item) => item.value !== undefined);

        sortedData.sort((a, b) => (config.sortOrder === "asc" ? a.value - b.value : b.value - a.value));
        createChart("chartsSorted", config, sortedData);
        geoFilters.forEach((geoFilter) => createChart("chartsSorted", config, sortedData, null, geoFilter));

        // 创建 Top 图表
        const top_count = 50;
        const rowIndex = Math.floor(index / 2) + 1;
        const containerId = `topChartRow${rowIndex}`;
        createChart(containerId, config, sortedData, top_count);
        geoFilters.forEach((geoFilter) => createChart(containerId, config, sortedData, top_count, geoFilter));
      });
    </script>
  </body>
</html>
